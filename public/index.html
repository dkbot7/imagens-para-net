<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üì∏ Imagens para publicar</title>
  <style>
    /* ============================================
       DESIGN SYSTEM 2025 - AVIF CONVERTER
       ============================================ */

    /* RESET & BASE */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Color Palette - Modern & Professional */
      --primary: #6366F1;        /* Indigo - Primary actions */
      --primary-hover: #4F46E5;  /* Indigo 700 */
      --primary-light: #818CF8;  /* Indigo 400 */

      --secondary: #14B8A6;      /* Teal - Success */
      --secondary-hover: #0D9488; /* Teal 700 */

      --accent: #F59E0B;         /* Amber - Highlights */
      --accent-hover: #D97706;   /* Amber 700 */

      --danger: #EF4444;         /* Red - Errors */
      --warning: #F59E0B;        /* Amber - Warnings */
      --success: #10B981;        /* Emerald - Success */

      /* Neutrals */
      --bg-primary: #F8FAFC;     /* Slate 50 */
      --bg-secondary: #F1F5F9;   /* Slate 100 */
      --surface: #FFFFFF;        /* White */
      --border: #E2E8F0;         /* Slate 200 */
      --border-hover: #CBD5E1;   /* Slate 300 */

      /* Text */
      --text-primary: #0F172A;   /* Slate 900 */
      --text-secondary: #64748B; /* Slate 500 */
      --text-tertiary: #94A3B8;  /* Slate 400 */
      --text-inverse: #FFFFFF;   /* White */

      /* Spacing Scale (8px grid) */
      --space-1: 0.25rem;  /* 4px */
      --space-2: 0.5rem;   /* 8px */
      --space-3: 0.75rem;  /* 12px */
      --space-4: 1rem;     /* 16px */
      --space-5: 1.5rem;   /* 24px */
      --space-6: 2rem;     /* 32px */
      --space-8: 3rem;     /* 48px */
      --space-10: 4rem;    /* 64px */

      /* Border Radius */
      --radius-sm: 0.375rem;  /* 6px */
      --radius-md: 0.5rem;    /* 8px */
      --radius-lg: 0.75rem;   /* 12px */
      --radius-xl: 1rem;      /* 16px */

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

      /* Typography */
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
    }

    body {
      font-family: var(--font-sans);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      min-height: 100vh;
      padding: var(--space-5);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
    }

    /* HEADER */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: var(--text-inverse);
      padding: var(--space-8) var(--space-6);
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: var(--space-2);
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    .header p {
      font-size: 1rem;
      opacity: 0.95;
      font-weight: 400;
    }

    /* CONTROLS PANEL */
    .controls {
      padding: var(--space-6);
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
    }

    .control-group {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
      align-items: center;
      background: var(--surface);
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .control-group:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow-sm);
    }

    .control-group label {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.875rem;
      letter-spacing: 0.01em;
    }

    /* INPUT ELEMENTS */
    select, input[type="date"], input[type="text"], input[type="checkbox"] {
      padding: var(--space-2) var(--space-4);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      transition: all 0.2s;
      font-family: var(--font-sans);
      color: var(--text-primary);
    }

    input[type="text"] {
      min-width: 200px;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    /* BUTTONS */
    button, .btn-analyze, .btn-transform {
      padding: var(--space-3) var(--space-5);
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: var(--font-sans);
      letter-spacing: 0.025em;
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      white-space: nowrap;
    }

    .btn-analyze {
      background: var(--primary);
      color: var(--text-inverse);
      box-shadow: var(--shadow-sm);
    }

    .btn-analyze:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-analyze:active {
      transform: translateY(0);
    }

    button:disabled, .btn-analyze:disabled {
      background: var(--text-tertiary);
      cursor: not-allowed;
      opacity: 0.6;
      transform: none !important;
    }


    .btn-transform {
      background: var(--secondary);
      color: var(--text-inverse);
      font-size: 1rem;
      padding: var(--space-4) var(--space-8);
      box-shadow: var(--shadow-md);
    }

    .btn-transform:hover {
      background: var(--secondary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-transform:active {
      transform: translateY(0);
    }

    .btn-transform:disabled {
      background: var(--text-tertiary);
      cursor: not-allowed;
      opacity: 0.6;
      transform: none !important;
    }

    .upload-area {
      padding: 30px;
      border-bottom: 2px solid #e9ecef;
    }

    .dropzone {
      border: 3px dashed #dee2e6;
      border-radius: 12px;
      padding: 60px;
      text-align: center;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s;
    }

    .dropzone:hover, .dropzone.dragover {
      border-color: #667eea;
      background: #e7f1ff;
    }

    .dropzone h3 {
      color: #495057;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .dropzone p {
      color: #6c757d;
      font-size: 1.1rem;
    }

    #fileInput {
      display: none;
    }

    .images-grid {
      padding: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    .image-card {
      border: 2px solid #dee2e6;
      border-radius: 12px;
      overflow: hidden;
      background: white;
      transition: all 0.3s;
      cursor: pointer;
    }

    .image-card:hover {
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      transform: translateY(-5px);
    }

    .image-card.selected {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }

    .image-preview {
      width: 100%;
      max-height: 300px;
      min-height: 150px;
      object-fit: contain;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      display: block;
      border-bottom: 1px solid #dee2e6;
    }

    .image-preview[src=""], .image-preview:not([src]) {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      color: #adb5bd;
      font-size: 3rem;
    }

    .image-preview[src=""]:before, .image-preview:not([src]):before {
      content: "üñºÔ∏è";
    }

    .image-info {
      padding: 15px;
    }

    .image-name {
      font-weight: 600;
      color: #212529;
      margin-bottom: 8px;
      font-size: 1rem;
      word-break: break-all;
    }

    .image-description {
      color: #6c757d;
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .image-metadata {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      color: #495057;
      margin-bottom: 10px;
    }

    .metadata-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .metadata-label {
      font-weight: 600;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #e7f1ff;
      border-radius: 6px;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .checkbox-wrapper label {
      font-weight: 600;
      color: #667eea;
      cursor: pointer;
    }

    /* Folder Organization Styles */
    .folder-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: var(--text-inverse);
      padding: var(--space-4) var(--space-5);
      border-radius: var(--radius-lg);
      margin: var(--space-6) 0 var(--space-4) 0;
      box-shadow: var(--shadow-md);
    }

    .folder-name {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: var(--space-2);
    }

    .folder-icon {
      font-size: 1.5rem;
    }

    .folder-title {
      font-weight: 700;
    }

    .folder-count {
      font-size: 0.95rem;
      opacity: 0.9;
      font-weight: 500;
    }

    .folder-path {
      font-size: 0.85rem;
      opacity: 0.8;
      font-family: 'Courier New', monospace;
      padding-left: calc(1.5rem + var(--space-3));
      word-break: break-all;
    }

    .folder-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: var(--space-5);
      padding-bottom: var(--space-6);
      margin-bottom: var(--space-4);
      border-bottom: 2px solid var(--border);
    }

    .folder-grid:last-child {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 0;
    }

    .selection-controls {
      padding: 20px 30px;
      background: #e7f1ff;
      border-bottom: 2px solid #667eea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .action-bar {
      padding: 30px;
      background: #f8f9fa;
      border-top: 2px solid #e9ecef;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .selection-info {
      font-size: 1.1rem;
      color: #495057;
      font-weight: 600;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
      color: #667eea;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Progress Section - Moderna */
    .progress-section {
      display: none;
      padding: 40px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .progress-section.active {
      display: block;
    }

    .progress-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .progress-header h2 {
      font-size: 2rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .progress-header h2 .spinner-icon {
      display: inline-block;
      animation: spin 2s linear infinite;
    }

    .progress-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 30px;
      max-width: 800px;
      margin: 0 auto;
    }

    .progress-bar-wrapper {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      height: 40px;
      margin-bottom: 20px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      border-radius: 12px;
      position: relative;
    }

    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .progress-stat-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .progress-stat-label {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-bottom: 5px;
    }

    .progress-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .progress-current-file {
      background: rgba(255, 255, 255, 0.15);
      padding: 15px 20px;
      border-radius: 8px;
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
    }

    .progress-current-file .icon {
      font-size: 1.5rem;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Final Report Section */
    .report-section {
      display: none;
      padding: 40px 30px;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .report-section.active {
      display: block;
    }

    .report-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .report-header h2 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .report-container {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 30px;
      max-width: 900px;
      margin: 0 auto;
    }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .report-card {
      background: rgba(255, 255, 255, 0.2);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .report-card-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .report-card-label {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .report-card-value {
      font-size: 2rem;
      font-weight: 700;
    }

    .report-savings {
      background: rgba(255, 255, 255, 0.25);
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
    }

    .report-savings-value {
      font-size: 3rem;
      font-weight: 700;
      margin: 10px 0;
    }

    .report-failed-list {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
    }

    .report-failed-list h3 {
      margin-bottom: 15px;
      font-size: 1.2rem;
    }

    .report-failed-list ul {
      list-style: none;
      padding: 0;
    }

    .report-failed-list li {
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 8px;
      border-radius: 6px;
    }

    .alert {
      padding: 20px;
      margin: 20px 30px;
      border-radius: 8px;
      font-weight: 500;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .hidden {
      display: none !important;
    }

    .quality-slider {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .quality-slider input[type="range"] {
      flex: 1;
      max-width: 200px;
    }

    .quality-value {
      font-weight: 600;
      color: #667eea;
      font-size: 1.1rem;
      min-width: 60px;
    }

    .download-section {
      padding: 40px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .download-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .download-header h2 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .download-header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .download-actions {
      text-align: center;
      margin-bottom: 30px;
    }

    .btn-download-zip {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      border: none;
      padding: 20px 50px;
      border-radius: 12px;
      font-size: 1.3rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .btn-download-zip:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }

    .download-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .download-item {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      gap: 15px;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }

    .download-item:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }

    .download-item-thumbnail {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid rgba(255,255,255,0.3);
      flex-shrink: 0;
    }

    .download-item-info {
      flex: 1;
    }

    .download-item-name {
      font-weight: 600;
      margin-bottom: 5px;
      word-break: break-word;
    }

    .download-item-size {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .btn-download-single {
      background: rgba(255,255,255,0.9);
      color: #667eea;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .btn-download-single:hover {
      background: white;
      transform: scale(1.05);
    }

    .btn-rename, .btn-confirm-rename, .btn-cancel-rename {
      background: rgba(255,255,255,0.9);
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
      font-size: 0.9rem;
    }

    .btn-rename {
      color: var(--accent);
    }

    .btn-rename:hover {
      background: var(--accent);
      color: white;
      transform: scale(1.05);
    }

    .btn-confirm-rename {
      color: var(--secondary);
      padding: 8px 12px;
    }

    .btn-confirm-rename:hover {
      background: var(--secondary);
      color: white;
      transform: scale(1.1);
    }

    .btn-cancel-rename {
      color: var(--danger);
      padding: 8px 12px;
    }

    .btn-cancel-rename:hover {
      background: var(--danger);
      color: white;
      transform: scale(1.1);
    }

    .download-item-name-edit {
      font-weight: 600;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üì∏ Imagens para publicar</h1>
      <p>Converta suas imagens para AVIF otimizado para web. ‚ö†Ô∏è N√£o salvamos seus dados - fa√ßa o download ou perder√° as imagens!</p>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="control-group">
        <label>üéØ Formatos a buscar:</label>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" class="format-filter" value="jpg" checked>
            JPG/JPEG
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" class="format-filter" value="png" checked>
            PNG
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" class="format-filter" value="webp" checked>
            WebP
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" class="format-filter" value="gif" checked>
            GIF
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" class="format-filter" value="bmp" checked>
            BMP
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" class="format-filter" value="tiff">
            TIFF
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" class="format-filter" value="avif">
            AVIF
          </label>
        </div>
      </div>

      <!-- Downloads Section -->
      <div class="control-group">
        <div style="display: flex; gap: var(--space-3); flex-wrap: wrap; align-items: center; width: 100%;">
          <label for="periodSelect" style="min-width: 80px;">üìÖ Per√≠odo:</label>
          <select id="periodSelect" style="min-width: 150px;">
            <option value="24h">√öltimas 24 horas</option>
            <option value="48h">√öltimas 48 horas</option>
            <option value="72h">√öltimas 72 horas</option>
            <option value="today">Hoje</option>
            <option value="custom">Personalizado</option>
          </select>

          <div id="customDates" class="hidden" style="display: flex; gap: var(--space-2);">
            <input type="date" id="startDate">
            <input type="date" id="endDate">
          </div>
        </div>

        <div style="display: flex; gap: var(--space-4); flex-wrap: wrap; align-items: center; width: 100%; margin-top: var(--space-3);">
          <label style="display: inline-flex; align-items: center; gap: var(--space-2); cursor: pointer; background: var(--bg-secondary); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); border: 1px solid var(--border);">
            <input type="checkbox" id="downloadsRecursive">
            <span>üóÇÔ∏è Incluir subpastas</span>
          </label>

          <button class="btn-analyze" onclick="analyzeDownloads()">
            üîç Analisar Downloads
          </button>
        </div>
      </div>

      <!-- Custom Folder - Unified Component -->
      <div class="control-group">
        <div style="display: flex; gap: var(--space-3); flex-wrap: wrap; align-items: center; width: 100%;">
          <label for="customFolderPath">üìÇ Escolha uma pasta:</label>
          <div style="display: flex; gap: var(--space-2); flex: 1; max-width: 500px;">
            <input type="text" id="customFolderPath" placeholder="Digite o caminho ou use o bot√£o ‚Üí" style="flex: 1; min-width: 200px;">
            <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;">
            <button class="btn-analyze" onclick="document.getElementById('folderInput').click()" title="Navegar visualmente" style="padding: var(--space-2) var(--space-4);">
              üìÅ Navegar
            </button>
          </div>
        </div>

        <div style="display: flex; gap: var(--space-4); flex-wrap: wrap; align-items: center; width: 100%; margin-top: var(--space-3);">
          <label style="display: inline-flex; align-items: center; gap: var(--space-2); cursor: pointer; background: var(--bg-secondary); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); border: 1px solid var(--border);">
            <input type="checkbox" id="customFolderRecursive">
            <span>üóÇÔ∏è Incluir subpastas</span>
          </label>

          <button class="btn-analyze" onclick="analyzeCustomFolder()">
            üîç Analisar Pasta
          </button>

          <small style="color: var(--text-secondary); font-style: italic;">
            üí° Dica: Use "üìÅ Navegar" para escolher visualmente ou digite o caminho completo
          </small>
        </div>
      </div>

      <div class="control-group">
        <label>üéöÔ∏è Qualidade AVIF:</label>
        <div class="quality-slider">
          <input type="range" id="qualitySlider" min="50" max="95" value="75" step="5">
          <span class="quality-value" id="qualityValue">75</span>
        </div>
      </div>

      <!-- Watermark/Logo Controls -->
      <div class="control-group">
        <label>üñºÔ∏è Marca d'√°gua (opcional):</label>
        <div style="display: flex; gap: var(--space-4); flex-wrap: wrap; align-items: flex-start; width: 100%;">
          <div style="flex: 1; min-width: 200px;">
            <label for="logoInput" class="btn-analyze" style="display: inline-block; cursor: pointer; text-align: center; white-space: nowrap;">
              üì∑ Escolher Logo
            </label>
            <input type="file" id="logoInput" accept="image/*" style="display: none;">
            <div id="logoPreview" style="margin-top: var(--space-2); display: none;">
              <img id="logoPreviewImg" style="max-width: 150px; max-height: 150px; border: 2px solid var(--border); border-radius: var(--radius-md); object-fit: contain;">
              <button onclick="removeLogo()" style="margin-top: var(--space-2); padding: var(--space-1) var(--space-2); background: var(--danger); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.85rem;">
                ‚ùå Remover
              </button>
            </div>
          </div>

          <div style="flex: 2; min-width: 300px;">
            <div style="margin-bottom: var(--space-3);">
              <label style="display: block; margin-bottom: var(--space-2); font-size: 0.9rem;">
                üìè Tamanho do logo (% da largura): <span id="logoSizeValue" style="font-weight: 700; color: var(--primary);">15</span>%
              </label>
              <input type="range" id="logoSizeSlider" min="5" max="50" value="15" step="1" style="width: 100%;">
            </div>

            <div style="margin-bottom: var(--space-3);">
              <label style="display: block; margin-bottom: var(--space-2); font-size: 0.9rem;">
                üíß Transpar√™ncia: <span id="logoOpacityValue" style="font-weight: 700; color: var(--primary);">70</span>%
              </label>
              <input type="range" id="logoOpacitySlider" min="10" max="100" value="70" step="5" style="width: 100%;">
            </div>

            <div>
              <label style="display: block; margin-bottom: var(--space-2); font-size: 0.9rem;">
                üìç Posi√ß√£o do logo:
              </label>
              <select id="logoPosition" style="width: 100%; padding: var(--space-2); border-radius: var(--radius-sm); border: 1px solid var(--border);">
                <option value="bottom-right">Canto inferior direito</option>
                <option value="bottom-left">Canto inferior esquerdo</option>
                <option value="top-right">Canto superior direito</option>
                <option value="top-left">Canto superior esquerdo</option>
                <option value="center">Centro</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Selection Controls -->
    <div class="selection-controls hidden" id="selectionControls">
      <div class="selection-info">
        <span id="selectedCountTop">0</span> de <span id="totalImagesCount">0</span> imagens selecionadas
      </div>
      <div class="control-group">
        <button class="btn-analyze" onclick="selectAll()">
          ‚úÖ Selecionar Todas
        </button>
        <button class="btn-analyze" onclick="deselectAll()">
          ‚ùå Desselecionar Todas
        </button>
      </div>
    </div>

    <!-- Upload Area -->
    <div class="upload-area">
      <div class="dropzone" id="dropzone" onclick="document.getElementById('fileInput').click()">
        <h3>üì§ Ou escolha/arraste imagens aqui</h3>
        <p>Clique para selecionar ou arraste arquivos para esta √°rea</p>
        <input type="file" id="fileInput" accept="image/*" multiple>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Analisando imagens...</p>
    </div>

    <!-- Images Grid -->
    <div class="images-grid" id="imagesGrid"></div>

    <!-- Action Bar -->
    <div class="action-bar hidden" id="actionBar">
      <button class="btn-transform" onclick="convertToAVIF()" id="btnTransform" disabled>
        ‚ú® TRANSFORMAR
      </button>
    </div>

    <!-- Progress Section -->
    <div class="progress-section" id="progressSection">
      <div class="progress-header">
        <h2><span class="spinner-icon">üîÑ</span> Convertendo para AVIF</h2>
        <p>Aguarde enquanto suas imagens s√£o transformadas...</p>
      </div>

      <div class="progress-container">
        <div class="progress-bar-wrapper">
          <div class="progress-bar-fill" id="progressBarFill">
            <span id="progressPercent">0%</span>
          </div>
        </div>

        <div class="progress-stats">
          <div class="progress-stat-item">
            <div class="progress-stat-label">Processadas</div>
            <div class="progress-stat-value" id="progressProcessed">0/0</div>
          </div>
          <div class="progress-stat-item">
            <div class="progress-stat-label">‚úÖ Sucesso</div>
            <div class="progress-stat-value" id="progressSuccess">0</div>
          </div>
          <div class="progress-stat-item">
            <div class="progress-stat-label">‚ùå Falhou</div>
            <div class="progress-stat-value" id="progressFailed">0</div>
          </div>
          <div class="progress-stat-item">
            <div class="progress-stat-label">üíæ Economizado</div>
            <div class="progress-stat-value" id="progressSaved">0 MB</div>
          </div>
        </div>

        <div class="progress-current-file" id="progressCurrentFile">
          <span class="icon">‚è≥</span>
          <span id="progressFileName">Iniciando...</span>
        </div>
      </div>
    </div>

    <!-- Download Section -->
    <div class="download-section hidden" id="downloadSection">
      <div class="download-header">
        <h2>‚úÖ Convers√£o Conclu√≠da - Baixar Imagens</h2>
        <p><span id="downloadCount">0</span> imagens convertidas para AVIF</p>
      </div>

      <div class="download-actions">
        <button class="btn-download-zip" onclick="downloadZIP()" id="btnDownloadZip">
          üì¶ BAIXAR TODAS (ZIP)
        </button>
      </div>

      <div class="download-list" id="downloadList">
        <!-- Lista de downloads individuais ser√° inserida aqui -->
      </div>
    </div>

    <!-- Report Section -->
    <div class="report-section" id="reportSection">
      <div class="report-header">
        <h2>üìä Relat√≥rio de Convers√£o</h2>
        <p>Sua convers√£o foi conclu√≠da com sucesso!</p>
      </div>

      <div class="report-container">
        <div class="report-savings">
          <div style="font-size: 1.2rem; opacity: 0.9;">Economia Total</div>
          <div class="report-savings-value" id="reportSavingsValue">0 MB</div>
          <div style="font-size: 1.5rem; opacity: 0.9;"><span id="reportSavingsPercent">0%</span> de redu√ß√£o</div>
        </div>

        <div class="report-grid">
          <div class="report-card">
            <div class="report-card-icon">‚úÖ</div>
            <div class="report-card-label">Convertidas</div>
            <div class="report-card-value" id="reportConverted">0</div>
          </div>
          <div class="report-card">
            <div class="report-card-icon">üìä</div>
            <div class="report-card-label">Total</div>
            <div class="report-card-value" id="reportTotal">0</div>
          </div>
          <div class="report-card">
            <div class="report-card-icon">‚è±Ô∏è</div>
            <div class="report-card-label">Tempo Total</div>
            <div class="report-card-value" id="reportTime">0s</div>
          </div>
          <div class="report-card">
            <div class="report-card-icon">üì¶</div>
            <div class="report-card-label">Tamanho Original</div>
            <div class="report-card-value" id="reportOriginalSize">0 MB</div>
          </div>
          <div class="report-card">
            <div class="report-card-icon">üéØ</div>
            <div class="report-card-label">Tamanho AVIF</div>
            <div class="report-card-value" id="reportAvifSize">0 MB</div>
          </div>
          <div class="report-card">
            <div class="report-card-icon">üìà</div>
            <div class="report-card-label">Taxa Sucesso</div>
            <div class="report-card-value" id="reportSuccessRate">0%</div>
          </div>
        </div>

        <div class="report-failed-list hidden" id="reportFailedList">
          <h3>‚ö†Ô∏è Imagens que falharam:</h3>
          <ul id="reportFailedItems"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentImages = [];
    let selectedImages = new Set();
    let currentSessionId = null;
    let logoFile = null;

    // Atualizar valor da qualidade
    document.getElementById('qualitySlider').addEventListener('input', (e) => {
      document.getElementById('qualityValue').textContent = e.target.value;
    });

    // Logo upload handling
    document.getElementById('logoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        logoFile = file;
        const reader = new FileReader();
        reader.onload = (ev) => {
          document.getElementById('logoPreviewImg').src = ev.target.result;
          document.getElementById('logoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    // Logo size slider
    document.getElementById('logoSizeSlider').addEventListener('input', (e) => {
      document.getElementById('logoSizeValue').textContent = e.target.value;
    });

    // Logo opacity slider
    document.getElementById('logoOpacitySlider').addEventListener('input', (e) => {
      document.getElementById('logoOpacityValue').textContent = e.target.value;
    });

    // Remove logo function
    function removeLogo() {
      logoFile = null;
      document.getElementById('logoInput').value = '';
      document.getElementById('logoPreview').style.display = 'none';
      document.getElementById('logoPreviewImg').src = '';
    }

    // Mostrar/esconder datas customizadas
    document.getElementById('periodSelect').addEventListener('change', (e) => {
      const customDates = document.getElementById('customDates');
      if (e.target.value === 'custom') {
        customDates.classList.remove('hidden');
      } else {
        customDates.classList.add('hidden');
      }
    });

    // Drag and drop
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropzone.addEventListener(eventName, () => {
        dropzone.classList.add('dragover');
      });
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, () => {
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      handleFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
      const files = e.target.files;
      handleFiles(files);
    });

    // Folder input handler - Processar arquivos da pasta diretamente
    const folderInput = document.getElementById('folderInput');
    folderInput.addEventListener('change', async (e) => {
      const files = e.target.files;
      if (files.length === 0) return;

      // Extrair nome da pasta
      const firstFile = files[0];
      const relativePath = firstFile.webkitRelativePath || '';
      const folderName = relativePath ? relativePath.split('/')[0] : 'Pasta selecionada';

      // Atualizar campo de texto com o nome da pasta
      document.getElementById('customFolderPath').value = folderName;

      // Obter formatos selecionados
      const selectedFormats = getSelectedFormats();
      if (selectedFormats.length === 0) {
        showAlert('error', 'Selecione pelo menos um formato de imagem');
        return;
      }

      // Filtrar apenas imagens dos formatos selecionados
      const formatToExtensions = {
        'jpg': ['.jpg', '.jpeg'],
        'png': ['.png'],
        'gif': ['.gif'],
        'webp': ['.webp'],
        'bmp': ['.bmp'],
        'tiff': ['.tiff', '.tif'],
        'avif': ['.avif']
      };

      let allowedExtensions = [];
      selectedFormats.forEach(format => {
        if (formatToExtensions[format]) {
          allowedExtensions.push(...formatToExtensions[format]);
        }
      });

      const imageFiles = Array.from(files).filter(file => {
        const ext = '.' + file.name.split('.').pop().toLowerCase();
        return allowedExtensions.includes(ext);
      });

      if (imageFiles.length === 0) {
        showAlert('error', 'Nenhuma imagem encontrada nos formatos selecionados');
        return;
      }

      // Processar imagens diretamente no frontend
      showLoading(true);
      await handleFolderFiles(imageFiles, folderName);
      showLoading(false);
    });

    async function handleFolderFiles(files, folderName) {
      try {
        const imagesData = [];

        for (const file of files) {
          try {
            // Criar preview da imagem e obter dimens√µes
            const thumbData = await createThumbnail(file);

            // Obter informa√ß√µes b√°sicas
            const fileInfo = {
              name: file.name,
              path: file.webkitRelativePath || file.name,
              modified: new Date(file.lastModified),
              description: `Imagem ${file.type.split('/')[1]?.toUpperCase() || 'desconhecida'} com resolu√ß√£o ${thumbData.width}x${thumbData.height} pixels, tamanho ${formatBytes(file.size)}`,
              metadata: {
                format: file.type.split('/')[1] || 'unknown',
                width: thumbData.width,
                height: thumbData.height,
                size: file.size,
                sizeFormatted: formatBytes(file.size)
              },
              thumbnail: thumbData.thumbnail,
              file: file  // Guardar refer√™ncia ao arquivo para convers√£o
            };

            imagesData.push(fileInfo);
          } catch (err) {
            console.error(`Erro ao processar ${file.name}:`, err);
          }
        }

        if (imagesData.length > 0) {
          currentImages = imagesData;
          renderImages();
          showAlert('success', `${imagesData.length} imagens encontradas em ${folderName}`);
        } else {
          showAlert('error', 'Nenhuma imagem p√¥de ser processada');
        }
      } catch (error) {
        showAlert('error', 'Erro ao processar pasta: ' + error.message);
      }
    }

    async function createThumbnail(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Calcular dimens√µes mantendo aspect ratio
            let width = img.width;
            let height = img.height;
            const maxSize = 300;

            if (width > height) {
              if (width > maxSize) {
                height = (height * maxSize) / width;
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = (width * maxSize) / height;
                height = maxSize;
              }
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

            // Retornar thumbnail e dimens√µes originais
            resolve({
              thumbnail: canvas.toDataURL('image/jpeg', 0.8),
              width: img.width,
              height: img.height
            });
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async function handleFiles(files) {
      if (files.length === 0) return;

      const formData = new FormData();
      for (const file of files) {
        formData.append('images', file);
      }

      showLoading(true);

      try {
        const response = await fetch('http://localhost:8765/api/upload', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          currentImages = data.images;
          renderImages();
          showAlert('success', `${data.count} imagens carregadas com sucesso!`);
        } else {
          showAlert('error', data.error);
        }
      } catch (error) {
        showAlert('error', 'Erro ao fazer upload: ' + error.message);
      } finally {
        showLoading(false);
        fileInput.value = '';
      }
    }

    function getSelectedFormats() {
      const checkboxes = document.querySelectorAll('.format-filter:checked');
      const formats = Array.from(checkboxes).map(cb => cb.value);
      return formats;
    }

    async function analyzeDownloads() {
      const formats = getSelectedFormats();

      if (formats.length === 0) {
        showAlert('error', 'Selecione pelo menos um formato de imagem');
        return;
      }

      const period = document.getElementById('periodSelect').value;
      let periodData;

      if (period === 'custom') {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
          showAlert('error', 'Selecione as datas de in√≠cio e fim');
          return;
        }

        periodData = { start: startDate, end: endDate };
      } else {
        periodData = period;
      }

      // Pegar op√ß√£o de busca recursiva espec√≠fica para Downloads
      const recursive = document.getElementById('downloadsRecursive').checked;

      showLoading(true);

      try {
        const response = await fetch('http://localhost:8765/api/analyze-downloads', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            period: periodData,
            formats: formats,
            recursive: recursive
          })
        });

        const data = await response.json();

        if (data.success) {
          currentImages = data.images;
          renderImages();
          showAlert('success', `${data.count} imagens encontradas na pasta Downloads`);
        } else {
          showAlert('error', data.error);
        }
      } catch (error) {
        showAlert('error', 'Erro ao analisar Downloads: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    async function analyzeCustomFolder() {
      const formats = getSelectedFormats();

      if (formats.length === 0) {
        showAlert('error', 'Selecione pelo menos um formato de imagem');
        return;
      }

      const folderPath = document.getElementById('customFolderPath').value.trim();

      if (!folderPath) {
        showAlert('error', 'Digite o caminho da pasta');
        return;
      }

      const period = document.getElementById('periodSelect').value;
      let periodData;

      if (period === 'custom') {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
          showAlert('error', 'Selecione as datas de in√≠cio e fim');
          return;
        }

        periodData = { start: startDate, end: endDate };
      } else {
        periodData = period;
      }

      // Pegar op√ß√£o de busca recursiva espec√≠fica para Pasta Customizada
      const recursive = document.getElementById('customFolderRecursive').checked;

      showLoading(true);

      try {
        const response = await fetch('http://localhost:8765/api/analyze-folder', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            folderPath: folderPath,
            period: periodData,
            formats: formats,
            recursive: recursive
          })
        });

        const data = await response.json();

        if (data.success) {
          currentImages = data.images;
          renderImages();
          showAlert('success', `${data.count} imagens encontradas em ${folderPath}`);
        } else {
          showAlert('error', data.error);
        }
      } catch (error) {
        showAlert('error', 'Erro ao analisar pasta: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    function renderImages() {
      const grid = document.getElementById('imagesGrid');
      grid.innerHTML = '';

      if (currentImages.length === 0) {
        grid.innerHTML = '<div class="alert alert-info">Nenhuma imagem encontrada</div>';
        document.getElementById('selectionControls').classList.add('hidden');
        document.getElementById('actionBar').classList.add('hidden');
        return;
      }

      // Agrupar imagens por pasta
      const imagesByFolder = {};

      currentImages.forEach((img, index) => {
        // Extrair diret√≥rio do caminho completo
        let folderPath = img.path.substring(0, img.path.lastIndexOf('\\'));
        if (folderPath.lastIndexOf('/') > folderPath.lastIndexOf('\\')) {
          folderPath = img.path.substring(0, img.path.lastIndexOf('/'));
        }

        // Se n√£o encontrar separador, usar "Imagens Carregadas"
        if (!folderPath || folderPath === img.path) {
          folderPath = 'üì§ Imagens Carregadas';
        }

        if (!imagesByFolder[folderPath]) {
          imagesByFolder[folderPath] = [];
        }

        imagesByFolder[folderPath].push({ ...img, originalIndex: index });
      });

      // Renderizar cada pasta com suas imagens
      const folders = Object.keys(imagesByFolder).sort();

      folders.forEach(folderPath => {
        const images = imagesByFolder[folderPath];

        // Criar header da pasta
        const folderHeader = document.createElement('div');
        folderHeader.className = 'folder-header';

        // Extrair nome da pasta (√∫ltima parte do caminho)
        let folderName = folderPath;
        const lastSeparator = Math.max(folderPath.lastIndexOf('\\'), folderPath.lastIndexOf('/'));
        if (lastSeparator > -1) {
          folderName = folderPath.substring(lastSeparator + 1);
        }

        folderHeader.innerHTML = `
          <div class="folder-name">
            <span class="folder-icon">üìÅ</span>
            <span class="folder-title">${folderName}</span>
            <span class="folder-count">(${images.length} ${images.length === 1 ? 'imagem' : 'imagens'})</span>
          </div>
          <div class="folder-path">${folderPath}</div>
        `;

        grid.appendChild(folderHeader);

        // Criar container para imagens da pasta
        const folderGrid = document.createElement('div');
        folderGrid.className = 'folder-grid';

        images.forEach((img) => {
          const card = document.createElement('div');
          card.className = 'image-card';
          card.dataset.index = img.originalIndex;
          card.dataset.path = img.path;

          card.innerHTML = `
            <img src="${img.thumbnail}" alt="${img.name}" class="image-preview">
            <div class="image-info">
              <div class="image-name">${img.name}</div>
              <div class="image-description">${img.description}</div>
              <div class="image-metadata">
                <div class="metadata-item">
                  <span class="metadata-label">Formato:</span>
                  <span>${img.metadata.format.toUpperCase()}</span>
                </div>
                <div class="metadata-item">
                  <span class="metadata-label">Resolu√ß√£o:</span>
                  <span>${img.metadata.width}x${img.metadata.height}</span>
                </div>
                <div class="metadata-item">
                  <span class="metadata-label">Tamanho:</span>
                  <span>${img.metadata.sizeFormatted}</span>
                </div>
              </div>
              <div class="checkbox-wrapper">
                <input type="checkbox" id="check-${img.originalIndex}" onchange="toggleSelection('${img.path}', this.checked)" onclick="event.stopPropagation()">
                <label for="check-${img.originalIndex}">Selecionar para converter</label>
              </div>
            </div>
          `;

          // Adicionar click handler ao card inteiro
          card.addEventListener('click', () => {
            const checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            toggleSelection(img.path, checkbox.checked);
          });

          folderGrid.appendChild(card);
        });

        grid.appendChild(folderGrid);
      });

      // Mostrar controles de sele√ß√£o e barra de a√ß√£o
      document.getElementById('selectionControls').classList.remove('hidden');
      document.getElementById('actionBar').classList.remove('hidden');

      // Atualizar contador total
      document.getElementById('totalImagesCount').textContent = currentImages.length;

      // Reset sele√ß√£o
      selectedImages.clear();
      updateSelectionUI();
    }

    function toggleSelection(path, selected) {
      if (selected) {
        selectedImages.add(path);
      } else {
        selectedImages.delete(path);
      }

      updateSelectionUI();
    }

    function updateSelectionUI() {
      const count = selectedImages.size;
      document.getElementById('selectedCountTop').textContent = count;
      document.getElementById('btnTransform').disabled = count === 0;

      // Highlight selected cards
      document.querySelectorAll('.image-card').forEach(card => {
        const path = card.dataset.path;
        if (selectedImages.has(path)) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      });
    }

    // Fun√ß√µes auxiliares para progresso e relat√≥rio
    function showProgressSection() {
      document.getElementById('progressSection').classList.add('active');
      document.getElementById('progressSection').scrollIntoView({ behavior: 'smooth' });
    }

    function hideProgressSection() {
      document.getElementById('progressSection').classList.remove('active');
    }

    function updateProgress(processed, total, success, failed, savedBytes, currentFileName) {
      const percent = Math.round((processed / total) * 100);

      document.getElementById('progressBarFill').style.width = percent + '%';
      document.getElementById('progressPercent').textContent = percent + '%';
      document.getElementById('progressProcessed').textContent = `${processed}/${total}`;
      document.getElementById('progressSuccess').textContent = success;
      document.getElementById('progressFailed').textContent = failed;
      document.getElementById('progressSaved').textContent = formatBytes(savedBytes);
      document.getElementById('progressFileName').textContent = currentFileName;
    }

    function showReport(stats) {
      // Mostrar se√ß√£o de relat√≥rio
      document.getElementById('reportSection').classList.add('active');

      // Preencher dados
      const savingsPercent = stats.originalSize > 0 ? Math.round(((stats.originalSize - stats.avifSize) / stats.originalSize) * 100) : 0;
      const successRate = Math.round((stats.success / stats.total) * 100);

      document.getElementById('reportSavingsValue').textContent = formatBytes(stats.originalSize - stats.avifSize);
      document.getElementById('reportSavingsPercent').textContent = savingsPercent + '%';
      document.getElementById('reportConverted').textContent = stats.success;
      document.getElementById('reportTotal').textContent = stats.total;
      document.getElementById('reportTime').textContent = stats.timeSeconds + 's';
      document.getElementById('reportOriginalSize').textContent = formatBytes(stats.originalSize);
      document.getElementById('reportAvifSize').textContent = formatBytes(stats.avifSize);
      document.getElementById('reportSuccessRate').textContent = successRate + '%';

      // Lista de falhas
      if (stats.failedFiles && stats.failedFiles.length > 0) {
        document.getElementById('reportFailedList').classList.remove('hidden');
        const failedList = document.getElementById('reportFailedItems');
        failedList.innerHTML = stats.failedFiles.map(f => `<li>‚ùå ${f}</li>`).join('');
      }

      document.getElementById('reportSection').scrollIntoView({ behavior: 'smooth' });
    }

    async function convertToAVIF() {
      if (selectedImages.size === 0) {
        showAlert('error', 'Nenhuma imagem selecionada');
        return;
      }

      const quality = parseInt(document.getElementById('qualitySlider').value);
      const selectedPaths = Array.from(selectedImages);
      const hasFileObjects = currentImages.some(img => img.file);

      // Preparar vari√°veis de controle
      const startTime = Date.now();
      let processed = 0;
      let success = 0;
      let failed = 0;
      let originalSize = 0;
      let avifSize = 0;
      const failedFiles = [];

      // Calcular tamanho original total
      for (const path of selectedPaths) {
        const img = currentImages.find(i => i.path === path);
        if (img && img.metadata) {
          originalSize += img.metadata.size;
        }
      }

      // Mostrar progress section
      showProgressSection();
      hideProgressSection(); // esconder primeiro
      document.getElementById('selectionControls').classList.add('hidden');
      document.getElementById('actionBar').classList.add('hidden');

      // Aguardar um momento antes de mostrar progress
      setTimeout(() => showProgressSection(), 100);

      try {
        let response, data;

        if (hasFileObjects) {
          // Imagens v√™m do bot√£o Navegar - usar upload
          const formData = new FormData();

          for (const path of selectedPaths) {
            const img = currentImages.find(i => i.path === path);
            if (img && img.file) {
              formData.append('images', img.file);
              // Simular progresso
              setTimeout(() => {
                processed++;
                updateProgress(processed, selectedPaths.length, processed, 0, 0, img.name);
              }, processed * 500);
            }
          }

          formData.append('quality', quality);

          // Adicionar logo se foi selecionado
          if (logoFile) {
            formData.append('logo', logoFile);
            formData.append('logoSize', document.getElementById('logoSizeSlider').value);
            formData.append('logoOpacity', document.getElementById('logoOpacitySlider').value);
            formData.append('logoPosition', document.getElementById('logoPosition').value);
          }

          response = await fetch('http://localhost:8765/api/convert-uploaded', {
            method: 'POST',
            body: formData
          });
        } else {
          // Imagens v√™m de path do sistema (Downloads ou pasta digitada)
          // Simular progresso durante convers√£o
          const progressInterval = setInterval(() => {
            if (processed < selectedPaths.length) {
              processed++;
              const currentImg = currentImages.find(i => i.path === selectedPaths[processed - 1]);
              updateProgress(processed, selectedPaths.length, processed, 0, 0, currentImg ? currentImg.name : 'Processando...');
            }
          }, 1000);

          // Preparar par√¢metros de convers√£o
          const convertParams = {
            images: selectedPaths,
            quality: quality
          };

          // Adicionar logo se foi selecionado
          if (logoFile) {
            // Converter logo para base64 para enviar via JSON
            const logoBase64 = await new Promise((resolve) => {
              const reader = new FileReader();
              reader.onload = (e) => resolve(e.target.result);
              reader.readAsDataURL(logoFile);
            });

            convertParams.logo = logoBase64;
            convertParams.logoSize = parseInt(document.getElementById('logoSizeSlider').value);
            convertParams.logoOpacity = parseInt(document.getElementById('logoOpacitySlider').value);
            convertParams.logoPosition = document.getElementById('logoPosition').value;
          }

          response = await fetch('http://localhost:8765/api/convert-to-avif', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(convertParams)
          });

          clearInterval(progressInterval);
        }

        data = await response.json();

        if (data.success) {
          // Calcular estat√≠sticas finais
          success = data.converted;
          failed = data.total - data.converted;
          processed = data.total;

          // Calcular tamanho AVIF total
          data.images.forEach(img => {
            // Remover "KB", "MB" etc e converter para bytes
            const sizeStr = img.size;
            if (sizeStr.includes('KB')) {
              avifSize += parseFloat(sizeStr) * 1024;
            } else if (sizeStr.includes('MB')) {
              avifSize += parseFloat(sizeStr) * 1024 * 1024;
            }
          });

          const timeSeconds = Math.round((Date.now() - startTime) / 1000);

          // Atualizar progresso final
          updateProgress(processed, data.total, success, failed, originalSize - avifSize, 'Conclu√≠do!');

          // Aguardar 1 segundo antes de mostrar relat√≥rio
          await new Promise(resolve => setTimeout(resolve, 1000));

          // Esconder progress
          hideProgressSection();

          // Mostrar relat√≥rio
          showReport({
            success,
            failed,
            total: data.total,
            originalSize,
            avifSize,
            timeSeconds,
            failedFiles
          });

          // Armazenar sessionId
          currentSessionId = data.sessionId;

          // Aguardar mais 2 segundos antes de mostrar downloads
          await new Promise(resolve => setTimeout(resolve, 2000));

          // Mostrar se√ß√£o de downloads
          showDownloads(data);

          // Limpar sele√ß√£o
          selectedImages.clear();
          document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
          updateSelectionUI();
        } else {
          hideProgressSection();
          showAlert('error', data.error);
        }
      } catch (error) {
        hideProgressSection();
        showAlert('error', 'Erro na convers√£o: ' + error.message);
      }
    }

    function showDownloads(data) {
      const downloadSection = document.getElementById('downloadSection');
      const downloadCount = document.getElementById('downloadCount');
      const downloadList = document.getElementById('downloadList');

      // Atualizar contador
      downloadCount.textContent = data.converted;

      // Limpar lista anterior
      downloadList.innerHTML = '';

      // Adicionar cada imagem
      data.images.forEach((image, index) => {
        const item = document.createElement('div');
        item.className = 'download-item';
        item.id = `download-item-${index}`;

        // URL da imagem convertida para preview
        const imageUrl = `http://localhost:8765/api/download/${currentSessionId}/${encodeURIComponent(image.filename)}`;

        item.innerHTML = `
          <img src="${imageUrl}" alt="${image.filename}" class="download-item-thumbnail" onerror="this.style.display='none'">
          <div class="download-item-info">
            <div class="download-item-name" id="filename-display-${index}">${image.filename}</div>
            <input type="text" class="download-item-name-edit hidden" id="filename-edit-${index}" value="${image.filename}" style="width: 100%; padding: 4px; border: 2px solid var(--primary); border-radius: 4px;">
            <div class="download-item-size">${image.size}</div>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button class="btn-rename" id="btn-rename-${index}" onclick="startRename(${index})" title="Mudar nome">
              ‚úèÔ∏è Renomear
            </button>
            <button class="btn-confirm-rename hidden" id="btn-confirm-${index}" onclick="confirmRename(${index}, '${image.filename}')" title="Confirmar">
              ‚úÖ
            </button>
            <button class="btn-cancel-rename hidden" id="btn-cancel-${index}" onclick="cancelRename(${index}, '${image.filename}')" title="Cancelar">
              ‚ùå
            </button>
            <button class="btn-download-single" id="btn-download-${index}" onclick="downloadSingle('${image.filename}', ${index})">
              üì• Baixar
            </button>
          </div>
        `;
        downloadList.appendChild(item);

        // Adicionar listener para Enter no input
        const input = item.querySelector(`#filename-edit-${index}`);
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            confirmRename(index, image.filename);
          }
        });
      });

      // Mostrar se√ß√£o
      downloadSection.classList.remove('hidden');
    }

    // Armazenar mapeamento de nomes originais -> novos nomes
    const filenameMap = {};

    function startRename(index) {
      // Mostrar input, esconder display
      document.getElementById(`filename-display-${index}`).classList.add('hidden');
      document.getElementById(`filename-edit-${index}`).classList.remove('hidden');

      // Mostrar bot√µes de confirmar/cancelar, esconder bot√£o renomear
      document.getElementById(`btn-rename-${index}`).classList.add('hidden');
      document.getElementById(`btn-confirm-${index}`).classList.remove('hidden');
      document.getElementById(`btn-cancel-${index}`).classList.remove('hidden');

      // Focar no input
      document.getElementById(`filename-edit-${index}`).focus();
      document.getElementById(`filename-edit-${index}`).select();
    }

    function confirmRename(index, originalFilename) {
      const newFilename = document.getElementById(`filename-edit-${index}`).value.trim();

      if (!newFilename) {
        alert('Nome do arquivo n√£o pode estar vazio');
        return;
      }

      // Armazenar o novo nome
      filenameMap[originalFilename] = newFilename;

      // Atualizar display
      document.getElementById(`filename-display-${index}`).textContent = newFilename;

      // Voltar ao estado normal
      document.getElementById(`filename-display-${index}`).classList.remove('hidden');
      document.getElementById(`filename-edit-${index}`).classList.add('hidden');
      document.getElementById(`btn-rename-${index}`).classList.remove('hidden');
      document.getElementById(`btn-confirm-${index}`).classList.add('hidden');
      document.getElementById(`btn-cancel-${index}`).classList.add('hidden');
    }

    function cancelRename(index, originalFilename) {
      // Restaurar valor original
      document.getElementById(`filename-edit-${index}`).value = document.getElementById(`filename-display-${index}`).textContent;

      // Voltar ao estado normal
      document.getElementById(`filename-display-${index}`).classList.remove('hidden');
      document.getElementById(`filename-edit-${index}`).classList.add('hidden');
      document.getElementById(`btn-rename-${index}`).classList.remove('hidden');
      document.getElementById(`btn-confirm-${index}`).classList.add('hidden');
      document.getElementById(`btn-cancel-${index}`).classList.add('hidden');
    }

    function downloadSingle(originalFilename, index) {
      // Usar nome personalizado se houver, sen√£o usar o original
      const filename = filenameMap[originalFilename] || originalFilename;
      const url = `http://localhost:8765/api/download/${currentSessionId}/${encodeURIComponent(originalFilename)}`;

      // Criar link tempor√°rio para download com nome customizado
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function downloadZIP() {
      const url = `http://localhost:8765/api/download-zip/${currentSessionId}`;
      window.open(url, '_blank');
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('active', show);
    }

    function showAlert(type, message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;

      document.querySelector('.container').insertBefore(
        alertDiv,
        document.querySelector('.controls').nextSibling
      );

      setTimeout(() => alertDiv.remove(), 5000);
    }

    function selectAll() {
      // Selecionar todas as imagens
      currentImages.forEach(img => {
        selectedImages.add(img.path);
      });

      // Marcar todos os checkboxes
      document.querySelectorAll('.image-card input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
      });

      updateSelectionUI();
    }

    function deselectAll() {
      // Limpar sele√ß√£o
      selectedImages.clear();

      // Desmarcar todos os checkboxes
      document.querySelectorAll('.image-card input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
      });

      updateSelectionUI();
    }
  </script>
</body>
</html>
